<!DOCTYPE html>
<html>
<head>
    <title>Live Forex Chart</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; }
        #chart { height: 100vh; }
    </style>
</head>
<body>
    <div id="chart"></div>

    <script>
        const chart = LightweightCharts.createChart(document.getElementById('chart'), {
            width: window.innerWidth,
            height: window.innerHeight,
            timeScale: { timeVisible: true, secondsVisible: false },
        });

        const candleSeries = chart.addCandlestickSeries();

        // Sample historical data loader (you may fetch from your Laravel controller)
        fetch('/api/forex/candles') // Laravel API endpoint
            .then(res => res.json())
            .then(data => {
                candleSeries.setData(data); // format: [{time, open, high, low, close}]
            });

        // WebSocket live updates using Twelve Data or Finnhub
        const socket = new WebSocket('wss://ws.finnhub.io?token=YOUR_API_KEY');
        socket.onopen = () => {
            socket.send(JSON.stringify({ type: "subscribe", symbol: "OANDA:EUR_USD" }));
        };

        let lastBar = null;
        socket.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            const tick = msg.data?.[0];
            if (!tick) return;
            const t = Math.floor(tick.t / 1000);
            const p = tick.p;

            if (!lastBar || t > lastBar.time) {
                lastBar = { time: t, open: p, high: p, low: p, close: p };
                candleSeries.update(lastBar);
            } else {
                lastBar.high = Math.max(lastBar.high, p);
                lastBar.low = Math.min(lastBar.low, p);
                lastBar.close = p;
                candleSeries.update(lastBar);
            }
        };
    </script>
</body>
</html>
